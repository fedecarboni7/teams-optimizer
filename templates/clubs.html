<!DOCTYPE html>
<html lang="es">
<head>
    {% set active_page = 'clubes' %}
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-Q0GE6VCJGX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-Q0GE6VCJGX');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Gesti√≥n de Clubes - Armar Equipos</title>
    <link rel="apple-touch-icon" sizes="180x180" href="../static/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../static/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../static/favicon/favicon-16x16.png">
    <link rel="manifest" href="../static/favicon/site.webmanifest">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="/static/css/global.css">
    <link rel="stylesheet" type="text/css" href="/static/css/sidebar.css">
    <link rel="stylesheet" type="text/css" href="/static/css/navbar.css">
    <link rel="stylesheet" type="text/css" href="/static/css/clubs.css">
    <link rel="stylesheet" type="text/css" href="/static/css/clubs-management.css">
    <script src="/static/js/utils.js" defer></script>
    <script src="/static/js/clubSelector.js" defer></script>
    <script src="/static/js/ui.js" defer></script>
    <script src="/static/js/api.js" defer></script>
    <script src="/static/js/clubs.js" defer></script>
</head>
<body class="clubs-page">
    {% include '_sidebar.html' %}
    {% include '_navbar.html' %}

    <div class="main-content">
        <div class="page-header">
            <div class="page-header-content">
                <h1>Gesti√≥n de Clubes</h1>
                <p class="page-description">Administra tus clubes, miembros y configuraciones</p>
            </div>
            <button class="help-btn" id="help-btn" title="Ayuda">
                <i class="fas fa-question-circle"></i>
            </button>
        </div>

        <!-- Club Information Section -->
        <div class="club-info-section" id="clubInfoSection">
            <div class="club-card">
                <div class="club-header">
                    <div class="club-details">
                        <h2 id="currentClubName">Selecciona un club</h2>
                        <p id="currentClubDescription">Elige un club del selector para ver sus detalles</p>
                    </div>
                    <div class="club-actions">
                        <button id="invitationsBtn" class="icon-button notification-button" title="Invitaciones pendientes">
                            <i class="fa-solid fa-bell"></i>
                            <span id="invitationsBadge" class="notification-badge" style="display: none;">0</span>
                        </button>
                        <button id="deleteClubBtn" class="icon-button delete-club-button" title="Eliminar club" style="display: none;">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                </div>
                
                <div class="club-stats" id="clubStats" style="display: none;">
                    <div class="stat-item">
                        <span class="stat-number" id="userRole">-</span>
                        <span class="stat-label">Tu rol</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="memberCount">0</span>
                        <span class="stat-label">Miembros</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="playerCountV1">0</span>
                        <span class="stat-label">Jugadores (1-5)</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="playerCountV2">0</span>
                        <span class="stat-label">Jugadores (1-10)</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions Section -->
        <div class="quick-actions-section">
            <h3>Acciones R√°pidas</h3>
            <div class="action-cards">
                <div class="action-card" onclick="openCreateClubModal()">
                    <div class="action-icon">
                        <i class="fa-solid fa-plus"></i>
                    </div>
                    <div class="action-content">
                        <h4>Crear Club</h4>
                        <p>Crear un nuevo club</p>
                    </div>
                </div>
                
                <div class="action-card" id="manageMembersCard" onclick="openModal('manageModal')" style="display: none;">
                    <div class="action-icon">
                        <i class="fa-solid fa-users-cog"></i>
                    </div>
                    <div class="action-content">
                        <h4>Gestionar Miembros</h4>
                        <p>Ver y administrar roles</p>
                    </div>
                </div>

                <div class="action-card" id="leaveClubCard" onclick="confirmLeaveClub()" style="display: none;">
                    <div class="action-icon">
                        <i class="fa-solid fa-door-open"></i>
                    </div>
                    <div class="action-content">
                        <h4>Salir del Club</h4>
                        <p>Abandonar este club</p>
                    </div>
                </div>
            </div>
        </div>

    <!-- Modal para ver invitaciones -->
        <!-- Modal para invitaciones -->
    <div id="invitationsModal" class="club-modal" style="display: none;">
        <div class="modal-backdrop"></div>
        <div class="modal-container">
            <div class="modal-header">
                <h2><i class="fa-solid fa-bell"></i> Invitaciones Pendientes</h2>
                <button class="modal-close-btn" onclick="closeModal('invitationsModal')">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="invitationsList" class="invitations-list">
                    <div class="loading-state">
                        <i class="fa-solid fa-spinner fa-spin"></i>
                        <p>Cargando invitaciones...</p>
                    </div>
                </div>
                <div id="noInvitations" class="empty-state" style="display: none;">
                    <i class="fa-solid fa-inbox"></i>
                    <h3>No hay invitaciones pendientes</h3>
                    <p>Cuando recibas invitaciones a clubes aparecer√°n aqu√≠.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('invitationsModal')">
                    <i class="fa-solid fa-times"></i> Cerrar
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal para crear un nuevo club -->
    <div id="createClubModal" class="club-modal" style="display: none;">
        <div class="modal-backdrop"></div>
        <div class="modal-container">
            <div class="modal-header">
                <h2><i class="fa-solid fa-plus"></i> Crear Nuevo Club</h2>
                <button class="modal-close-btn" onclick="closeCreateClubModal()">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="new-club-name">Nombre del Club</label>
                    <input type="text" id="new-club-name" placeholder="Ingresa el nombre del club" maxlength="50" required>
                    <small class="form-help">El nombre debe tener entre 3 y 50 caracteres</small>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeCreateClubModal()">
                    <i class="fa-solid fa-times"></i> Cancelar
                </button>
                <button class="btn btn-primary" onclick="createNewClub()">
                    <i class="fa-solid fa-plus"></i> Crear Club
                </button>
            </div>
        </div>
    </div>    <!-- Modal de Gesti√≥n de Miembros -->
        <!-- Modal para gestionar miembros -->
    <div id="manageModal" class="club-modal" style="display: none;">
        <div class="modal-backdrop"></div>
        <div class="modal-container large">
            <!-- Contenido principal del modal -->
            <div id="membersContent">
                <div class="modal-header">
                    <h2><i class="fa-solid fa-users"></i> Miembros del Club</h2>
                    <div class="modal-actions">
                        <button id="inviteBtn" class="modal-close-btn" title="Invitar" style="display: none;">
                            <i class="fa-solid fa-user-plus"></i>
                        </button>
                        <button class="modal-close-btn" onclick="closeModal('manageModal')">
                            <i class="fa-solid fa-times"></i>
                        </button>
                    </div>
                </div>
                <div class="modal-body">
                    <div class="members-table-container">
                        <table class="members-table">
                            <thead>
                                <tr>
                                    <th>Usuario</th>
                                    <th>Rol</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="membersTableBody">
                                <!-- Members will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="confirmChangesBtn" class="btn btn-primary" onclick="confirmRoleChanges()" style="display: none;">
                        <i class="fa-solid fa-check"></i> Confirmar Cambios
                    </button>
                    <button class="btn btn-secondary" onclick="closeModal('manageModal')">
                        <i class="fa-solid fa-times"></i> Cerrar
                    </button>
                </div>
            </div>
            
            <!-- Contenido de invitar (se muestra cuando se hace clic en invitar) -->
            <div id="inviteContent" style="display: none;">
                <div class="modal-header">
                    <div class="back-action">
                        <button class="modal-close-btn" title="Volver" onclick="showMembersContent()">
                            <i class="fa-solid fa-arrow-left"></i>
                        </button>
                        <h2><i class="fa-solid fa-user-plus"></i> Invitar Miembro</h2>
                    </div>
                    <button class="modal-close-btn" onclick="closeModal('manageModal')">
                        <i class="fa-solid fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="inviteUsernameInput">Nombre de usuario</label>
                        <input type="text" id="inviteUsernameInput" placeholder="Ingresa el nombre de usuario" required>
                        <small class="form-help">El usuario debe estar registrado en la plataforma</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="showMembersContent()">
                        <i class="fa-solid fa-arrow-left"></i> Volver
                    </button>
                    <button class="btn btn-primary" onclick="sendInvitation()">
                        <i class="fa-solid fa-paper-plane"></i> Enviar Invitaci√≥n
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables espec√≠ficas para la p√°gina de clubes
        let currentClubData = null;

        // Funci√≥n de integraci√≥n con clubSelector.js
        function onContextChanged(contextId) {
            // Sincronizar variables globales tanto en window como en clubs.js
            window.clubId = contextId !== 'my-players' ? contextId : null;
            if (typeof clubId !== 'undefined') {
                clubId = window.clubId;
            }
            
            // Resetear el rol del club cuando se cambie de contexto
            if (window.currentUser) {
                window.currentUser.clubRole = null;
                currentUser = window.currentUser;
            }
            
            updateClubDisplay();
            if (window.clubId) {
                // Cargar miembros del club (esto actualizar√° el rol del usuario)
                if (typeof loadClubMembers === 'function') {
                    loadClubMembers();
                }
            }
            return Promise.resolve();
        }

        // Actualizar la visualizaci√≥n del club actual
        function updateClubDisplay() {
            const clubNameEl = document.getElementById('currentClubName');
            const clubDescEl = document.getElementById('currentClubDescription');
            const clubStatsEl = document.getElementById('clubStats');
            const membersSection = document.getElementById('membersSection');
            
            // Header buttons
            const deleteClubBtn = document.getElementById('deleteClubBtn');
            
            // Action cards
            const manageMembersCard = document.getElementById('manageMembersCard');
            const leaveClubCard = document.getElementById('leaveClubCard');

            if (window.clubId === null) {
                clubNameEl.textContent = 'Mis Jugadores';
                clubDescEl.textContent = 'Tus jugadores personales';
                clubStatsEl.style.display = 'none';
                if (membersSection) membersSection.style.display = 'none';
                
                // Hide header buttons
                if (deleteClubBtn) deleteClubBtn.style.display = 'none';
                
                // Hide club-specific actions
                if (manageMembersCard) manageMembersCard.style.display = 'none';
                if (leaveClubCard) leaveClubCard.style.display = 'none';
            } else {
                const clubs = getUserClubs();
                const club = clubs.find(c => c.id == window.clubId);
                
                if (club) {
                    clubNameEl.textContent = club.name;
                    clubDescEl.textContent = `Club creado para gestionar jugadores en equipo`;
                    clubStatsEl.style.display = 'flex';
                    if (membersSection) membersSection.style.display = 'block';
                    
                    // Show club-specific actions
                    if (manageMembersCard) manageMembersCard.style.display = 'flex';
                    
                    // Show role-specific actions (will be updated when club data loads)
                    updateRoleBasedActions();
                }
            }
        }

        // Actualizar acciones basadas en el rol del usuario
        function updateRoleBasedActions() {
            const leaveClubCard = document.getElementById('leaveClubCard');
            const deleteClubBtn = document.getElementById('deleteClubBtn');
            const inviteBtn = document.getElementById('inviteBtn');

            if (currentUser && currentUser.clubRole) {
                // Owner and admin can invite (through modal)
                if (currentUser.clubRole !== 'member') {
                    inviteBtn.style.display = 'inline-flex';
                } else {
                    inviteBtn.style.display = 'none';
                }

                // Only owner can delete club
                if (currentUser.clubRole === 'owner') {
                    if (deleteClubBtn) deleteClubBtn.style.display = 'inline-flex';
                    leaveClubCard.style.display = 'none';
                } else {
                    if (deleteClubBtn) deleteClubBtn.style.display = 'none';
                    leaveClubCard.style.display = 'flex';
                }

                // Update user role display
                const userRoleEl = document.getElementById('userRole');
                if (userRoleEl) {
                    userRoleEl.textContent = translateRole(currentUser.clubRole);
                }
            }
        }

        // Confirmar salir del club
        function confirmLeaveClub() {
            if (clubId && confirm('¬øEst√°s seguro de que quieres salir de este club?')) {
                leaveClub(clubId);
            }
        }

        // Confirmar eliminar club
        function confirmDeleteClub() {
            if (clubId && confirm('¬øEst√°s seguro de que quieres eliminar este club? Esta acci√≥n no se puede deshacer.')) {
                deleteClub(clubId);
            }
        }

        // Mostrar estad√≠sticas de miembros en cards
        async function updateMemberStats(members) {
            const memberCountEl = document.getElementById('memberCount');
            const playerCountV1El = document.getElementById('playerCountV1');
            const playerCountV2El = document.getElementById('playerCountV2');
            
            if (memberCountEl) {
                memberCountEl.textContent = members.length;
            }
            
            if (window.clubId) {
                try {
                    const [responseV1, responseV2] = await Promise.all([
                        fetch(`/api/players?scale=1-5&club_id=${window.clubId}`),
                        fetch(`/api/players?scale=1-10&club_id=${window.clubId}`)
                    ]);
                    
                    if (responseV1.ok && playerCountV1El) {
                        const playersV1 = await responseV1.json();
                        playerCountV1El.textContent = playersV1.length;
                    } else if (playerCountV1El) {
                        playerCountV1El.textContent = '0';
                    }
                    
                    if (responseV2.ok && playerCountV2El) {
                        const playersV2 = await responseV2.json();
                        playerCountV2El.textContent = playersV2.length;
                    } else if (playerCountV2El) {
                        playerCountV2El.textContent = '0';
                    }
                } catch (error) {
                    console.error('Error al cargar jugadores del club:', error);
                    if (playerCountV1El) playerCountV1El.textContent = '0';
                    if (playerCountV2El) playerCountV2El.textContent = '0';
                }
            } else {
                if (playerCountV1El) playerCountV1El.textContent = '0';
                if (playerCountV2El) playerCountV2El.textContent = '0';
            }
        }

        // Mostrar miembros en grid format
        function displayMembersGrid(members) {
            const membersGrid = document.getElementById('membersGrid');
            if (!membersGrid) return;

            membersGrid.innerHTML = '';

            members.forEach(member => {
                const memberCard = document.createElement('div');
                memberCard.className = 'member-card';
                
                const roleClass = member.role === 'owner' ? 'owner' : 
                                 member.role === 'admin' ? 'admin' : 'member';
                
                memberCard.innerHTML = `
                    <div class="member-avatar">
                        <i class="fa-solid fa-user"></i>
                    </div>
                    <div class="member-info">
                        <h4>${member.username}</h4>
                        <span class="member-role ${roleClass}">${member.role}</span>
                    </div>
                `;
                
                membersGrid.appendChild(memberCard);
            });

            updateMemberStats(members);
        }

        // Override the updateMembersTableUI function to also update the grid
        const originalUpdateMembersTableUI = window.updateMembersTableUI;
        window.updateMembersTableUI = function() {
            if (originalUpdateMembersTableUI) {
                originalUpdateMembersTableUI();
            }
            if (window.clubMembers) {
                displayMembersGrid(window.clubMembers);
            }
        };

        // Inicializaci√≥n cuando se carga la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            // Get current user data if available
            const currentUserData = document.getElementById('user-data');
            if (currentUserData) {
                try {
                    currentUser = JSON.parse(currentUserData.textContent);
                } catch (e) {
                    // Silently handle parse error
                }
            }

            // Initialize display
            updateClubDisplay();
        });
    </script>

    <!-- Modal de Ayuda (Clubes) -->
    <div class="help-modal" id="help-modal-clubs">
        <div class="help-modal-content">
            <div class="help-modal-header">
                <h2>üëã Bienvenido a Gesti√≥n de Clubes</h2>
                <button class="close-btn" id="close-help-modal-clubs">&times;</button>
            </div>
            <div class="help-modal-body">
                <p class="help-intro">Los clubes te permiten compartir jugadores con otras personas y organizar partidos en grupo.</p>

                <div class="help-section">
                    <h3>üè† Crear un Club</h3>
                    <p>Cre√° un club simplemente d√°ndole un nombre. Vos ser√°s el <strong>due√±o</strong> y podr√°s invitar a otras personas para compartir los perfiles de jugadores.</p>
                </div>

                <div class="help-section">
                    <h3>üîÑ Cambiar de Club</h3>
                    <p>Us√° el <strong>selector en la barra superior</strong> para cambiar entre tus clubes o volver a "Mis Jugadores".</p>
                </div>

                <div class="help-section">
                    <h3>üë• Roles y Permisos</h3>
                    <ul>
                        <li><strong>Due√±o:</strong> Control total ‚Äî invitar miembros, asignar roles, gestionar jugadores y eliminar el club</li>
                        <li><strong>Administrador:</strong> Puede invitar miembros y crear/editar/eliminar jugadores</li>
                        <li><strong>Miembro:</strong> Solo puede ver los jugadores, sin poder editarlos</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h3>‚úâÔ∏è Invitar Miembros</h3>
                    <p>Para invitar a alguien: seleccion√° el club ‚Üí <strong>Gestionar Miembros</strong> ‚Üí <strong>Invitar</strong> ‚Üí ingres√° el nombre de usuario.</p>
                </div>

                <div class="help-section">
                    <h3>üîî Invitaciones Pendientes</h3>
                    <p>Toc√° el <strong>√≠cono de campana</strong> para ver si ten√©s invitaciones a clubes. Pod√©s aceptarlas o rechazarlas desde ah√≠.</p>
                </div>

                <div class="help-tip">
                    üí° <strong>Tip:</strong> Pod√©s volver a ver esta ayuda tocando el bot√≥n <i class="fas fa-question-circle"></i> en cualquier momento.
                </div>
            </div>
            <div class="help-modal-footer">
                <button class="help-modal-btn" id="start-btn-clubs">¬°Entendido!</button>
            </div>
        </div>
    </div>

    <!-- Hidden element to pass user data to JavaScript -->
    {% if currentUser %}
    <script id="user-data" type="application/json">{{ currentUser | tojson | safe }}</script>
    {% endif %}
</body>
</html>